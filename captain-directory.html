<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neighborhood Captain Directory</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Alegreya:wght@800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --forest-dark: #283618;
      --forest-medium: #606C38;
      --cream: #FEFAE0;
      --tan: #DDA15E;
      --brown: #BC6C25;
      --mint-light: #afcc8e;
      --mint-lighter: #cdf4a0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--cream);
      color: var(--forest-dark);
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      font-family: 'Alegreya', serif;
      font-weight: 800;
      font-size: 2.5rem;
      color: var(--forest-dark);
      margin-bottom: 10px;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      color: var(--forest-medium);
      margin-bottom: 30px;
      font-size: 1.1rem;
    }

    .controls {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(40, 54, 24, 0.1);
      margin-bottom: 25px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--mint-light);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--forest-medium);
    }

    .filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      flex: 2;
    }

    .filter-select {
      padding: 10px 14px;
      border: 2px solid var(--mint-light);
      border-radius: 8px;
      background: white;
      font-size: 0.95rem;
      color: var(--forest-dark);
      cursor: pointer;
      transition: border-color 0.3s;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--forest-medium);
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(40, 54, 24, 0.1);
      flex: 1;
      min-width: 150px;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--forest-medium);
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--forest-dark);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--forest-medium);
      font-size: 1.1rem;
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .card {
      background: white;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(40, 54, 24, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      border-left: 4px solid var(--forest-medium);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 54, 24, 0.15);
    }

    .card-header {
      margin-bottom: 10px;
    }

    .card-name {
      font-family: 'Alegreya', serif;
      font-weight: 800;
      font-size: 1.2rem;
      color: var(--forest-dark);
      margin-bottom: 3px;
    }

    .card-zone {
      color: var(--forest-medium);
      font-weight: 500;
      font-size: 0.9rem;
    }

    .card-details {
      display: grid;
      gap: 6px;
    }

    .detail-row {
      display: flex;
      gap: 8px;
      padding: 5px 0;
      border-bottom: 1px solid var(--cream);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 600;
      color: var(--forest-medium);
      min-width: 120px;
      font-size: 0.85rem;
    }

    .detail-value {
      color: var(--forest-dark);
      flex: 1;
      font-size: 0.85rem;
    }

    .detail-value a {
      color: var(--forest-medium);
      text-decoration: none;
    }

    .detail-value a:hover {
      text-decoration: underline;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      margin: 2px;
    }

    .badge-yes {
      background: var(--mint-lighter);
      color: var(--forest-dark);
    }

    .badge-no {
      background: #f0f0f0;
      color: #666;
    }

    .badge-tag {
      background: var(--tan);
      color: var(--forest-dark);
    }

    .no-results {
      text-align: center;
      padding: 60px 20px;
      color: var(--forest-medium);
      font-size: 1.2rem;
    }

    .refresh-indicator {
      text-align: center;
      padding: 10px;
      color: var(--forest-medium);
      font-size: 0.85rem;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 2rem;
      }

      .cards-grid {
        grid-template-columns: 1fr;
      }

      .controls {
        flex-direction: column;
      }

      .search-box,
      .filter-group {
        width: 100%;
      }

      .filter-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Neighborhood Captain Directory</h1>
    <p class="subtitle">Find and connect with volunteer neighborhood captains</p>

    <div class="stats" id="stats">
      <div class="stat-card">
        <div class="stat-label">Total Captains</div>
        <div class="stat-value" id="totalCount">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Showing</div>
        <div class="stat-value" id="showingCount">-</div>
      </div>
    </div>

    <div class="controls">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search by name, zone, email, or any field...">
      </div>
      <div class="filter-group">
        <select class="filter-select" id="zoneFilter">
          <option value="">All Zones</option>
        </select>
        <select class="filter-select" id="censusTractFilter">
          <option value="">All Census Tracts</option>
        </select>
        <select class="filter-select" id="workingGroupFilter">
          <option value="">All Working Groups</option>
        </select>
        <select class="filter-select" id="languageFilter">
          <option value="">All Languages</option>
        </select>
        <select class="filter-select" id="typeFilter">
          <option value="">All Home Types</option>
        </select>
      </div>
    </div>

    <div id="refreshIndicator" class="refresh-indicator"></div>

    <div id="content">
      <div class="loading">Loading captain data...</div>
    </div>
  </div>

  <script>
    // Google Sheet CSV export URL (from published sheet)
    // Using CORS proxy for local testing - remove proxy when hosting online
    const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS7VT5oDIuF5dAkQ0QT78-WctiuEUzJtA0CBQgtAo9DFzPPIFsiHgDRHfltB5TrwhXsBUlreQMRvzcO/pub?output=csv';
    const CSV_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(GOOGLE_SHEET_URL);
    
    let allData = [];
    let filteredData = [];

    // Column headers as provided
    const COLUMNS = [
      'Name',
      'Zone',
      'Predominant Census Tract of Zone',
      'Phone',
      'Email',
      'Working Groups',
      'Location',
      'Type of home situation',
      'Interest or expertise areas',
      'Languages Fluent In',
      'Map Approved',
      'Voter Data Received',
      'Have you accessed the NC channel?'
    ];

    // Parse CSV data
    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) return [];

      const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length === 0 || !values[0]) continue;

        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index] || '';
        });
        data.push(row);
      }

      return data;
    }

    // Parse CSV line handling quoted fields
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    // Load data from Google Sheet
    async function loadData() {
      try {
        const response = await fetch(CSV_URL);
        if (!response.ok) throw new Error('Failed to fetch data');
        
        const text = await response.text();
        allData = parseCSV(text);
        
        if (allData.length === 0) {
          throw new Error('No data found in sheet');
        }

        updateFilters();
        applyFilters();
        updateRefreshIndicator();
      } catch (error) {
        document.getElementById('content').innerHTML = 
          `<div class="error">Error loading data: ${error.message}<br>Please check that the Google Sheet is published to the web.</div>`;
      }
    }

    // Update filter dropdowns with unique values
    function updateFilters() {
      const zones = [...new Set(allData.map(d => d.Zone).filter(Boolean))].sort();
      const censusTracts = [...new Set(allData.map(d => d['Predominant Census Tract of Zone']).filter(Boolean))].sort();
      const workingGroups = [...new Set(allData.flatMap(d => 
        (d['Working Groups'] || '').split(',').map(g => g.trim()).filter(Boolean)
      ))].sort();
      const languages = [...new Set(allData.flatMap(d => 
        (d['Languages Fluent In'] || '').split(',').map(l => l.trim()).filter(Boolean)
      ))].sort();
      const homeTypes = [...new Set(allData.map(d => d['Type of home situation']).filter(Boolean))].sort();

      populateSelect('zoneFilter', zones);
      populateSelect('censusTractFilter', censusTracts);
      populateSelect('workingGroupFilter', workingGroups);
      populateSelect('languageFilter', languages);
      populateSelect('typeFilter', homeTypes);
    }

    function populateSelect(selectId, options) {
      const select = document.getElementById(selectId);
      const currentValue = select.value;
      select.innerHTML = `<option value="">All ${selectId.replace('Filter', '').replace(/([A-Z])/g, ' $1').trim()}</option>`;
      options.forEach(option => {
        const optionEl = document.createElement('option');
        optionEl.value = option;
        optionEl.textContent = option;
        select.appendChild(optionEl);
      });
      if (currentValue && options.includes(currentValue)) {
        select.value = currentValue;
      }
    }

    // Apply filters and search
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const zoneFilter = document.getElementById('zoneFilter').value;
      const censusTractFilter = document.getElementById('censusTractFilter').value;
      const workingGroupFilter = document.getElementById('workingGroupFilter').value;
      const languageFilter = document.getElementById('languageFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;

      filteredData = allData.filter(item => {
        // Search filter
        if (searchTerm) {
          const searchableText = Object.values(item).join(' ').toLowerCase();
          if (!searchableText.includes(searchTerm)) return false;
        }

        // Zone filter
        if (zoneFilter && item.Zone !== zoneFilter) return false;

        // Census Tract filter
        if (censusTractFilter && item['Predominant Census Tract of Zone'] !== censusTractFilter) return false;

        // Working group filter
        if (workingGroupFilter) {
          const groups = (item['Working Groups'] || '').split(',').map(g => g.trim());
          if (!groups.includes(workingGroupFilter)) return false;
        }

        // Language filter
        if (languageFilter) {
          const languages = (item['Languages Fluent In'] || '').split(',').map(l => l.trim());
          if (!languages.includes(languageFilter)) return false;
        }

        // Type filter
        if (typeFilter && item['Type of home situation'] !== typeFilter) return false;

        return true;
      });

      renderCards();
      updateStats();
    }

    // Render captain cards
    function renderCards() {
      const content = document.getElementById('content');

      if (filteredData.length === 0) {
        content.innerHTML = '<div class="no-results">No captains found matching your search criteria.</div>';
        return;
      }

      content.innerHTML = '<div class="cards-grid"></div>';
      const grid = content.querySelector('.cards-grid');

      filteredData.forEach(item => {
        const card = document.createElement('div');
        card.className = 'card';

        const details = [];
        
        if (item.Phone) {
          details.push(createDetailRow('Phone', `<a href="tel:${item.Phone}">${item.Phone}</a>`));
        }
        if (item.Email) {
          details.push(createDetailRow('Email', `<a href="mailto:${item.Email}">${item.Email}</a>`));
        }
        if (item['Predominant Census Tract of Zone']) {
          details.push(createDetailRow('Census Tract', item['Predominant Census Tract of Zone']));
        }
        if (item.Location) {
          details.push(createDetailRow('Location', item.Location));
        }
        if (item['Type of home situation']) {
          details.push(createDetailRow('Home Type', item['Type of home situation']));
        }
        if (item['Working Groups']) {
          const groups = item['Working Groups'].split(',').map(g => g.trim()).filter(Boolean);
          details.push(createDetailRow('Working Groups', groups.map(g => `<span class="badge badge-tag">${g}</span>`).join('')));
        }
        if (item['Languages Fluent In']) {
          const languages = item['Languages Fluent In'].split(',').map(l => l.trim()).filter(Boolean);
          details.push(createDetailRow('Languages', languages.map(l => `<span class="badge badge-tag">${l}</span>`).join('')));
        }
        if (item['Interest or expertise areas']) {
          details.push(createDetailRow('Interests/Expertise', item['Interest or expertise areas']));
        }
        if (item['Map Approved']) {
          const approved = item['Map Approved'].toLowerCase().includes('yes') || item['Map Approved'].toLowerCase() === 'y';
          details.push(createDetailRow('Map Approved', `<span class="badge ${approved ? 'badge-yes' : 'badge-no'}">${item['Map Approved']}</span>`));
        }
        if (item['Voter Data Received']) {
          const received = item['Voter Data Received'].toLowerCase().includes('yes') || item['Voter Data Received'].toLowerCase() === 'y';
          details.push(createDetailRow('Voter Data', `<span class="badge ${received ? 'badge-yes' : 'badge-no'}">${item['Voter Data Received']}</span>`));
        }
        if (item['Have you accessed the NC channel?']) {
          const accessed = item['Have you accessed the NC channel?'].toLowerCase().includes('yes') || item['Have you accessed the NC channel?'].toLowerCase() === 'y';
          details.push(createDetailRow('NC Channel', `<span class="badge ${accessed ? 'badge-yes' : 'badge-no'}">${item['Have you accessed the NC channel?']}</span>`));
        }

        card.innerHTML = `
          <div class="card-header">
            <div class="card-name">${item.Name || 'Unnamed'}</div>
            ${item.Zone ? `<div class="card-zone">Zone: ${item.Zone}</div>` : ''}
          </div>
          <div class="card-details">
            ${details.join('')}
          </div>
        `;

        grid.appendChild(card);
      });
    }

    function createDetailRow(label, value) {
      return `
        <div class="detail-row">
          <div class="detail-label">${label}:</div>
          <div class="detail-value">${value || '—'}</div>
        </div>
      `;
    }

    // Update statistics
    function updateStats() {
      document.getElementById('totalCount').textContent = allData.length;
      document.getElementById('showingCount').textContent = filteredData.length;
    }

    // Update refresh indicator
    function updateRefreshIndicator() {
      const now = new Date();
      const timeString = now.toLocaleTimeString();
      document.getElementById('refreshIndicator').textContent = 
        `Last updated: ${timeString} • Auto-refreshes every 5 minutes`;
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('zoneFilter').addEventListener('change', applyFilters);
    document.getElementById('censusTractFilter').addEventListener('change', applyFilters);
    document.getElementById('workingGroupFilter').addEventListener('change', applyFilters);
    document.getElementById('languageFilter').addEventListener('change', applyFilters);
    document.getElementById('typeFilter').addEventListener('change', applyFilters);

    // Auto-refresh every 5 minutes
    setInterval(loadData, 5 * 60 * 1000);

    // Initial load
    loadData();
  </script>
</body>
</html>

